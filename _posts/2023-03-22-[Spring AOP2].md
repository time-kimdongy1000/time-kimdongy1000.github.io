---
title: Spring AOP 로 간단한 어플리케이션 만들기
author: kimdongy1000
date: 2023-03-22 11:07
categories: [Back-end, Spring - Core]
tags: [ AOP ]
math: true
mermaid: true
---

이번시간에는 지난시간에 배운것을 바탕으로 간단하게 로그 트레이서 어플리케이션을 만들어보겠습니다 

## maven 

```

<dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>

    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-test</artifactId>
        <scope>test</scope>
    </dependency>

    <!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-aop -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-aop</artifactId>
    </dependency>

    <dependency>
        <groupId>ch.qos.logback</groupId>
        <artifactId>logback-core</artifactId>
        <version>1.2.3</version>
        <exclusions>
            <exclusion>
                <groupId>org.slf4j</groupId>
                <artifactId>slf4j-api</artifactId>
            </exclusion>
        </exclusions>
        <scope>runtime</scope>
    </dependency>

    <dependency>
        <groupId>ch.qos.logback</groupId>
        <artifactId>logback-classic</artifactId>
        <version>1.2.3</version>
        <exclusions>
            <exclusion>
                <groupId>org.slf4j</groupId>
                <artifactId>slf4j-api</artifactId>
            </exclusion>
        </exclusions>
        <scope>runtime</scope>
    </dependency>

```

## logback.xml
```

<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <property name="LOGS_ABSOLUTE_PATH" value="./logs"/>

    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <layout class="ch.qos.logback.classic.PatternLayout">
            <Pattern>[%d{yyyy-MM-dd HH:mm:ss}:%-3relative][%thread] %-5level %logger{36} - %msg%n</Pattern>
        </layout>
    </appender>

    <appender name="INFO_LOG" class="ch.qos.logback.core.rolling.RollingFileAppender">

        <file>./logs/info.log</file>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>INFO</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
        <encoder>
            <pattern>[%d{yyyy-MM-dd HH:mm:ss}:%-3relative][%thread] %-5level %logger{35} - %msg%n</pattern>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>./was-logs/info.%d{yyyy-MM-dd}.%i.log.gz</fileNamePattern>
            <timeBasedFileNamingAndTriggeringPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedFNATP">
                <maxFileSize>100MB</maxFileSize>
            </timeBasedFileNamingAndTriggeringPolicy>
            <maxHistory>180</maxHistory>
        </rollingPolicy>
    </appender>


    <root level="INFO">
        <appender-ref ref="STDOUT"/>
        <appender-ref ref="INFO_LOG"/>
    </root>



</configuration>

```


## LoggerAspect.java
```
@Aspect
@Component
public class LoggerAspect {

    private Logger logger = LoggerFactory.getLogger(this.getClass());



    @Pointcut("execution(* com.cybb.main.app..*.*(..))")
    private void logPointCut(){}

    @Before("logPointCut()")
    public void before(JoinPoint joinPoint){
        logger.info("===========Before==================");
        logger.info("[Before] {}" , joinPoint.getSignature());
        logger.info("===========Before==================");
    }

    @After("logPointCut()")
    public void after(JoinPoint joinPoint ){
        logger.info("===========after==================");
        logger.info("[After] {}" , joinPoint.getSignature());
        logger.info("===========after==================");

    }

    @AfterReturning(value = "logPointCut()" , returning = "object" )
    public void after(JoinPoint joinPoint , Object object){
        logger.info("===========AfterReturning==================");
        logger.info("[AfterReturning] {}", object);
        logger.info("===========AfterReturning==================");


    }

    @AfterThrowing(value = "logPointCut()" , throwing = "ex")
    public void afterThrowing (JoinPoint joinPoint , Throwable ex){

        logger.info("===========Exception==================");
        logger.error("ex.getCause() : " + ex.getCause());
        logger.error("ex.getMessage() : "  + ex.getMessage());
        logger.error("ex.getStackTrace() : " + ex.getStackTrace());
        logger.info("===========Exception==================");

    }

}


```

## UserController.java
```
@RestController
public class UserController {

    @Autowired
    private Users users;

    @Autowired
    private UserService userService;

    @PostMapping("/insertUser")
    public ResponseEntity<User> insertUser(
            @RequestParam("name") String name,
            @RequestParam("age") int age
    ) throws Exception {

        try {

            Map<String , Object> param = new HashMap<>();
            param.put("name" , name);
            param.put("age" , age);


            return new ResponseEntity<>(userService.insertUser(param) , HttpStatus.OK);

        } catch (Exception e) {

            return new ResponseEntity<>(null , HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }
}


```

## UserService.java
```
@Service
public class UserService {

    @Autowired
    private Users users;

    public User insertUser(Map<String , Object> param){

        User user = new User();
        user.setUserId(UUID.randomUUID().toString());
        user.setName((String)param.get("name"));
        user.setAge((int)(param.get("age")));

        UserValidation userValidation = new UserValidation();
        Errors errors = new BeanPropertyBindingResult(user, "user");

        userValidation.validate(user, errors);

        errors.getAllErrors().forEach(e -> {
            throw new RuntimeException(e.getDefaultMessage());
        });

        users.addUser(user);

        return user;

    }
}


```

## AppConfig.java
```
@Configuration
@EnableAspectJAutoProxy
public class AppConfig {
}


```

## UserValidation.java
```
public class UserValidation implements Validator {

    @Override
    public boolean supports(Class<?> clazz) {
        return User.class.equals(clazz);
    }

    @Override
    public void validate(Object target, Errors errors) {

        User user = (User)target;

        if(user.getName().length() < 8 || !StringUtils.hasText(user.getName())){
            errors.rejectValue("name" , "name length inValid" , "이름의 길이가 올바르지 않습니다.");
        }

        if(user.getAge() < 10){
            errors.rejectValue("age" , "Invalid age" , "나이가 올바르지 않습니다.");
        }
    }
}


```

## User.java

```

package com.cybb.main.domain;

public class User {

    private String userId;
    private String name;
    private int age;

    public String getName() {
        return name;
    }

    public String getUserId() {
        return userId;
    }

    public void setUserId(String userId) {
        this.userId = userId;
    }

    public void setName(String name) {
        this.name = name;
    }

    public int getAge() {
        return age;
    }

    public void setAge(int age) {
        this.age = age;
    }
}


```

## Users.java
```

package com.cybb.main.domain;

import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;

@Component
public class Users {

    private final List<User> userList = new ArrayList<>();


    public void addUser(User user){
        userList.add(user);
    }
}


```

지난시간에 했던 Validataion 까지 했다 내용이 궁금하다면 우측 상단 검색에서 Validation 을 검색하면된다 

테스트는 간단하다 첫번째는 올바른 데이터를 넣었을떄이다 

```

[2023-03-22 14:16:33:384107][http-nio-8080-exec-9] INFO  com.cybb.main.aop.LoggerAspect - ===========Before==================
[2023-03-22 14:16:33:384107][http-nio-8080-exec-9] INFO  com.cybb.main.aop.LoggerAspect - [Before] ResponseEntity com.cybb.main.app.controller.UserController.insertUser(String,int)
[2023-03-22 14:16:33:384108][http-nio-8080-exec-9] INFO  com.cybb.main.aop.LoggerAspect - ===========Before==================
[2023-03-22 14:16:33:384108][http-nio-8080-exec-9] INFO  com.cybb.main.aop.LoggerAspect - ===========Before==================
[2023-03-22 14:16:33:384108][http-nio-8080-exec-9] INFO  com.cybb.main.aop.LoggerAspect - [Before] User com.cybb.main.app.service.UserService.insertUser(Map)
[2023-03-22 14:16:33:384108][http-nio-8080-exec-9] INFO  com.cybb.main.aop.LoggerAspect - ===========Before==================
[2023-03-22 14:16:33:384108][http-nio-8080-exec-9] INFO  com.cybb.main.aop.LoggerAspect - ===========AfterReturning==================
[2023-03-22 14:16:33:384108][http-nio-8080-exec-9] INFO  com.cybb.main.aop.LoggerAspect - [AfterReturning] com.cybb.main.domain.User@41f594ca
[2023-03-22 14:16:33:384108][http-nio-8080-exec-9] INFO  com.cybb.main.aop.LoggerAspect - ===========AfterReturning==================
[2023-03-22 14:16:33:384108][http-nio-8080-exec-9] INFO  com.cybb.main.aop.LoggerAspect - ===========after==================
[2023-03-22 14:16:33:384108][http-nio-8080-exec-9] INFO  com.cybb.main.aop.LoggerAspect - [After] User com.cybb.main.app.service.UserService.insertUser(Map)
[2023-03-22 14:16:33:384108][http-nio-8080-exec-9] INFO  com.cybb.main.aop.LoggerAspect - ===========after==================
[2023-03-22 14:16:33:384109][http-nio-8080-exec-9] INFO  com.cybb.main.aop.LoggerAspect - ===========AfterReturning==================
[2023-03-22 14:16:33:384109][http-nio-8080-exec-9] INFO  com.cybb.main.aop.LoggerAspect - [AfterReturning] <200 OK OK,com.cybb.main.domain.User@41f594ca,[]>
[2023-03-22 14:16:33:384109][http-nio-8080-exec-9] INFO  com.cybb.main.aop.LoggerAspect - ===========AfterReturning==================
[2023-03-22 14:16:33:384109][http-nio-8080-exec-9] INFO  com.cybb.main.aop.LoggerAspect - ===========after==================
[2023-03-22 14:16:33:384109][http-nio-8080-exec-9] INFO  com.cybb.main.aop.LoggerAspect - [After] ResponseEntity com.cybb.main.app.controller.UserController.insertUser(String,int)
[2023-03-22 14:16:33:384109][http-nio-8080-exec-9] INFO  com.cybb.main.aop.LoggerAspect - ===========after==================


```

이런식으로 로그가 찍히는 것을 확인했다 현재 서비스 로직이 어디에서 어디 까지 들어가는지 살퍄보았다 
그리고 문제를 발생시키면 

```
[2023-03-22 14:17:33:444018][http-nio-8080-exec-2] INFO  com.cybb.main.aop.LoggerAspect - ===========Before==================
[2023-03-22 14:17:33:444018][http-nio-8080-exec-2] INFO  com.cybb.main.aop.LoggerAspect - [Before] ResponseEntity com.cybb.main.app.controller.UserController.insertUser(String,int)
[2023-03-22 14:17:33:444018][http-nio-8080-exec-2] INFO  com.cybb.main.aop.LoggerAspect - ===========Before==================
[2023-03-22 14:17:33:444018][http-nio-8080-exec-2] INFO  com.cybb.main.aop.LoggerAspect - ===========Before==================
[2023-03-22 14:17:33:444019][http-nio-8080-exec-2] INFO  com.cybb.main.aop.LoggerAspect - [Before] User com.cybb.main.app.service.UserService.insertUser(Map)
[2023-03-22 14:17:33:444019][http-nio-8080-exec-2] INFO  com.cybb.main.aop.LoggerAspect - ===========Before==================
[2023-03-22 14:17:33:444019][http-nio-8080-exec-2] INFO  com.cybb.main.aop.LoggerAspect - ===========Exception==================
[2023-03-22 14:17:33:444019][http-nio-8080-exec-2] ERROR com.cybb.main.aop.LoggerAspect - ex.getCause() : null
[2023-03-22 14:17:33:444019][http-nio-8080-exec-2] ERROR com.cybb.main.aop.LoggerAspect - ex.getMessage() : 이름의 길이가 올바르지 않습니다.
[2023-03-22 14:17:33:444019][http-nio-8080-exec-2] ERROR com.cybb.main.aop.LoggerAspect - ex.getStackTrace() : [Ljava.lang.StackTraceElement;@759c48c0
[2023-03-22 14:17:33:444019][http-nio-8080-exec-2] INFO  com.cybb.main.aop.LoggerAspect - ===========Exception==================
[2023-03-22 14:17:33:444019][http-nio-8080-exec-2] INFO  com.cybb.main.aop.LoggerAspect - ===========after==================
[2023-03-22 14:17:33:444019][http-nio-8080-exec-2] INFO  com.cybb.main.aop.LoggerAspect - [After] User com.cybb.main.app.service.UserService.insertUser(Map)
[2023-03-22 14:17:33:444020][http-nio-8080-exec-2] INFO  com.cybb.main.aop.LoggerAspect - ===========after==================
[2023-03-22 14:17:33:444020][http-nio-8080-exec-2] INFO  com.cybb.main.aop.LoggerAspect - ===========AfterReturning==================
[2023-03-22 14:17:33:444020][http-nio-8080-exec-2] INFO  com.cybb.main.aop.LoggerAspect - [AfterReturning] <500 INTERNAL_SERVER_ERROR Internal Server Error,[]>
[2023-03-22 14:17:33:444020][http-nio-8080-exec-2] INFO  com.cybb.main.aop.LoggerAspect - ===========AfterReturning==================
[2023-03-22 14:17:33:444020][http-nio-8080-exec-2] INFO  com.cybb.main.aop.LoggerAspect - ===========after==================
[2023-03-22 14:17:33:444020][http-nio-8080-exec-2] INFO  com.cybb.main.aop.LoggerAspect - [After] ResponseEntity com.cybb.main.app.controller.UserController.insertUser(String,int)
[2023-03-22 14:17:33:444020][http-nio-8080-exec-2] INFO  com.cybb.main.aop.LoggerAspect - ===========after==================


```

이렇게 에러가 발생했을땐 어디서 문제가 발생되었는지 어떤 문제가 있는지 전부 기록이 되고 있다 이를 바탕으로 문제를 해결할 수 있다 우리는 간단하게 Aop 를 활용하여 어플리케이션을 만들어보았다