---
title: SQL_튜닝_15
author: kimdongy1000
date: 2023-09-15 10:00
categories: [Back-end, SQL_Tuning]
tags: [DataBase - Oracle , SQL_Tuning]
math: true
mermaid: true
---

## 자동형변환 
오라클에서는 자동형변환이 있습니다 예를 들어서 컬럼이 타입은 varchar(Stirng) 타입이지만 사용자가 숫자를 넣어도 오라클은 알아서 형변활을 하게 됩니다 이를 실해계획으로 보면 이렇게 보입니다 

```

EXPLAIN PLAN FOR 
SELECT * 
FROM Ex5_Student 
WHERE birthday > 20050605

SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY);

PLAN_TABLE_OUTPUT                                                                |
---------------------------------------------------------------------------------+
Plan hash value: 185264460                                                       |
                                                                                 |
---------------------------------------------------------------------------------|
| Id  | Operation         | Name        | Rows  | Bytes | Cost (%CPU)| Time     ||
---------------------------------------------------------------------------------|
|   0 | SELECT STATEMENT  |             |  7859 | 94308 |    11   (0)| 00:00:01 ||
|*  1 |  TABLE ACCESS FULL| EX5_STUDENT |  7859 | 94308 |    11   (0)| 00:00:01 ||
---------------------------------------------------------------------------------|
                                                                                 |
Predicate Information (identified by operation id):                              |
---------------------------------------------------                              |
                                                                                 |
   1 - filter(TO_NUMBER("BIRTHDAY")>20050605)                                    |
                                                                                 |
Note                                                                             |
-----                                                                            |
   - dynamic statistics used: dynamic sampling (level=2)                         |

```

오퍼레이션은 뒤에보고 아래 Predicate Information 이 부분을 보게 되면 1 - filter(TO_NUMBER("BIRTHDAY")>20050605) 현재 옵티마이저가 알아서 BIRTHDAY 을 TO_NuMBER 로 변환해서 비교하는모습을 보고 있습니다 마약 이 컬럼이 인덱스 선두 컬럼이라면 선두컬럼 가공으로 인한 Index Range Scan 이 되지 않습니다 

## 소스 

<https://gitlab.com/kimdongy1000/sqltuningproject>

이곳에서 Ex5_student , Ex6_student 를 찾자 아래 .sql 파일도 스키마도 마련해두었습니다 

## 간단한 테이블 스키마
```

DROP TABLE Ex5_Student

CREATE TABLE Ex5_Student(
    name varchar(9),
    birthday varchar(8)
)

CREATE INDEX Ex5_Student_idx ON Ex5_Student (birthday  , name);


DROP TABLE Ex6_Student

CREATE TABLE Ex6_Student(
    name varchar(9),
    birthday number
)

CREATE INDEX Ex6_Student_idx ON Ex6_Student (birthday  , name);



```

앞으로 소스코드는 생략하겠습니다 소스코드는 git 을 참조해주세요 소스코드로 1만명의 학생을 만들었습니다 이때 인덱스는 birthday 컬럼이 선두컬럼이 되게됩니다 그럼 다시 위에 있는 실행계획을 가져오겠습니다 

```

EXPLAIN PLAN FOR 
SELECT * 
FROM Ex5_Student 
WHERE birthday > 20050605

SELECT * FROM TABLE(DBMS_XPLAN.DISPLAY);

PLAN_TABLE_OUTPUT                                                                |
---------------------------------------------------------------------------------+
Plan hash value: 185264460                                                       |
                                                                                 |
---------------------------------------------------------------------------------|
| Id  | Operation         | Name        | Rows  | Bytes | Cost (%CPU)| Time     ||
---------------------------------------------------------------------------------|
|   0 | SELECT STATEMENT  |             |  7859 | 94308 |    11   (0)| 00:00:01 ||
|*  1 |  TABLE ACCESS FULL| EX5_STUDENT |  7859 | 94308 |    11   (0)| 00:00:01 ||
---------------------------------------------------------------------------------|
                                                                                 |
Predicate Information (identified by operation id):                              |
---------------------------------------------------                              |
                                                                                 |
   1 - filter(TO_NUMBER("BIRTHDAY")>20050605)                                    |
                                                                                 |
Note                                                                             |
-----                                                                            |
   - dynamic statistics used: dynamic sampling (level=2)                         |

```

인덱스를 보고 다시 봐버리니 선두컬럼의 형변환이 일어나게 되어서 인덱스를 타지 못하고 Full scan 이 발생하는것을 볼 수 있습니다 이는 오라클의 형변환의 최대단점중에 하나입니다 그렇기에 만약 인덱스컬럼을 where 절에 써야 한다면 컬럼의 타입과 일치하게 비교를 해주어야 합니다 그렇지 않으면 옵티마이저는 지금처럼 쿼리를 아예변형시켜서 만들어놓은 인덱스를 사용못할 수 있습니다 

## 숫자형 VS 문자형 
지금 좌변 BIRTHDAY 문자형이고 우변 20050605 는 숫자이다 오라클에서 문자형과 숫자형이 만나면 숫자형 기준으로 비교를 하게 된다 즉 문자형인 죄변이 변환에 당첨된다 사실인지 확인을 해보자 

## Ex6_Student
```

DROP TABLE Ex6_Student

CREATE TABLE Ex6_Student(
    name varchar(9),
    birthday number
)


SELECT * FROM Ex6_Student

CREATE INDEX Ex6_Student_idx ON Ex6_Student (birthday  , name);



EXPLAIN PLAN FOR 
SELECT * 
FROM Ex6_Student 
WHERE birthday > '20050605'

PLAN_TABLE_OUTPUT                                                                |
---------------------------------------------------------------------------------+
Plan hash value: 3762763606                                                      |
                                                                                 |
---------------------------------------------------------------------------------|
| Id  | Operation         | Name        | Rows  | Bytes | Cost (%CPU)| Time     ||
---------------------------------------------------------------------------------|
|   0 | SELECT STATEMENT  |             |  7932 |   123K|    11   (0)| 00:00:01 ||
|*  1 |  TABLE ACCESS FULL| EX6_STUDENT |  7932 |   123K|    11   (0)| 00:00:01 ||
---------------------------------------------------------------------------------|
                                                                                 |
Predicate Information (identified by operation id):                              |
---------------------------------------------------                              |
                                                                                 |
   1 - filter("BIRTHDAY">20050605)                                               |

```

1 - filter("BIRTHDAY">20050605)  문자 '20050605' 에서 숫자 20050605 로 변경된것을 볼 수 있다 